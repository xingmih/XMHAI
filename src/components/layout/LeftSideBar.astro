---
import type { MarkdownHeading } from "astro";
import { widgetManager } from "@/utils/widget-manager";
import Announcement from "@/components/widget/Announcement.astro";
import Categories from "@/components/widget/Categories.astro";
import Profile from "@/components/content/Profile.astro";
import Tags from "@/components/widget/Tags.astro";
import TOC from "@/components/widget/TOC.astro";
import Advertisement from "@/components/widget/Advertisement.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Calendar from "@/components/widget/Calendar.astro";

interface Props {
  class?: string;
  headings?: MarkdownHeading[];
}

const { class: className, headings } = Astro.props;

// 判断当前是否为桌面端（通过 className 或其他方式）
// 在小于1024px时，获取所有组件；在桌面端只获取左侧组件
const isDesktopOnly = false; // 由于是服务端渲染，这里统一获取所有组件，通过CSS控制显示

// 获取所有组件（移动端和平板端需要），桌面端通过CSS hidden类过滤
const topComponents = widgetManager.getComponentsByPosition("top");
const stickyComponents = widgetManager.getComponentsByPosition("sticky");

// 提取客户端需要的数据
const sidebarConfig = {
  shouldShowSidebar: {
    mobile: widgetManager.shouldShowSidebar("mobile"),
    tablet: widgetManager.shouldShowSidebar("tablet"),
    desktop: widgetManager.shouldShowSidebar("desktop"),
  },
};

// 组件映射表
const componentMap = {
  profile: Profile,
  announcement: Announcement,
  categories: Categories,
  tags: Tags,
  toc: TOC,
  advertisement: Advertisement,
  stats: SiteStats,
  calendar: Calendar,
};

// 渲染组件的辅助函数
function renderComponent(component: any, index: number, _components: any[]) {
  const ComponentToRender =
    componentMap[component.type as keyof typeof componentMap];
  if (!ComponentToRender) return null;

  let componentClass = widgetManager.getComponentClass(component, index);
  
  // 对于右侧组件，在桌面端隐藏，在移动端和平板端显示
  // widgetManager已经自动添加了 "hidden lg:block"，我们需要反转这个逻辑
  // 使其在移动端和平板端显示，在桌面端仅显示左侧组件
  if (component.sidebar === "right") {
    // 移除自动添加的 "hidden lg:block"，改为 "block lg:hidden"
    componentClass = componentClass
      .replace(/hidden\s+lg:block/g, 'block lg:hidden')
      .replace(/\s+hidden\s+/g, ' ')
      .trim();
  }
  
  const componentStyle = widgetManager.getComponentStyle(component, index);

  return {
    Component: ComponentToRender,
    props: {
      class: componentClass,
      style: componentStyle,
      headings: component.type === "toc" ? headings : undefined,
      configId: component.configId,
      ...component.customProps,
    },
  };
}
---

<div id="left-sidebar" class:list={[className, "w-full"]}>
  <!-- 顶部固定组件区域 -->
  {
    topComponents.length > 0 && (
      <div class="flex flex-col w-full gap-4 mb-4">
        {topComponents.map((component, index) => {
          const renderData = renderComponent(component, index, topComponents);
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }

  <!-- 粘性组件区域 -->
  {
    stickyComponents.length > 0 && (
      <div
        id="left-sidebar-sticky"
        class="transition-all duration-700 flex flex-col w-full gap-4 sticky top-4"
      >
        {stickyComponents.map((component, index) => {
          const renderData = renderComponent(
            component,
            index,
            stickyComponents
          );
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }
</div>

<!-- 响应式样式和JavaScript -->
<style>
  /* 响应式断点样式 */
  @media (max-width: 768px) {
    #left-sidebar {
      display: var(--sidebar-mobile-display, block);
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    #left-sidebar {
      display: var(--sidebar-tablet-display, block);
    }
  }

  @media (min-width: 1025px) {
    #left-sidebar {
      display: var(--sidebar-desktop-display, block);
    }
  }
</style>

<script define:vars={{ sidebarConfig }}>
  // 响应式布局管理
  class LeftSidebarManager {
    constructor() {
      this.config = sidebarConfig;
    }
  }

  // 初始化左侧边栏管理器
  new LeftSidebarManager();
</script>
