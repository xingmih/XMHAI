---
import type { CollectionEntry } from "astro:content";
import { getPostUrlBySlug } from "@utils/url-utils";
import PostCard from "@/components/content/PostCard.astro";
import { siteConfig, sidebarLayoutConfig } from "@/config";

const { page } = Astro.props;

let delay = 0;
const interval = 50;

// 类型别名避免Fragment语法问题
type PostEntry = CollectionEntry<"posts">;

// 检查是否启用双侧边栏
const isBothSidebars = sidebarLayoutConfig.position === "both";
---

<div
  id="post-list-container"
  class="transition flex flex-col gap-4 md:gap-4 mb-4"
  style="opacity: 0;"
  data-default-layout={siteConfig.postListLayout.defaultMode}
  data-both-sidebars={isBothSidebars}
>
  {
    page.data.map((entry: PostEntry) => (
      <PostCard
        entry={entry}
        title={entry.data.title}
        tags={entry.data.tags}
        category={entry.data.category}
        published={entry.data.published}
        updated={entry.data.updated}
        url={getPostUrlBySlug(entry.id)}
        image={entry.data.image}
        description={entry.data.description}
        draft={entry.data.draft}
        pinned={entry.data.pinned}
        class:list="onload-animation post-card-item"
        style={`animation-delay: calc(var(--content-delay) + ${delay++ * interval}ms);`}
      />
    ))
  }
</div>

<script>
  // 动态布局切换脚本
  function initLayout() {
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;

    // 检查屏幕宽度
    const screenWidth = window.innerWidth;
    const isSmallScreen = screenWidth < 1200;

    // 从localStorage读取用户偏好
    const savedLayout = localStorage.getItem("postListLayout");
    const defaultLayout =
      postListContainer.getAttribute("data-default-layout") || "list";
    let currentLayout = savedLayout || defaultLayout;

    // 如果屏幕宽度小于1200px，强制使用列表模式
    if (isSmallScreen) {
      currentLayout = "list";
    }

    // 应用布局
    updatePostListLayout(currentLayout);
  }

  function updatePostListLayout(layout: string) {
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;

    // 检查是否启用双侧边栏
    const isBothSidebars = postListContainer.getAttribute("data-both-sidebars") === "true";
    const rightSidebar = document.getElementById('right-sidebar');
    const mainGrid = document.getElementById('main-grid');

    // 添加过渡动画类
    postListContainer.classList.add('layout-transitioning');

    if (layout === "grid") {
      // 切换到网格模式
      postListContainer.className =
        "transition-all duration-500 grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 grid-mode layout-transitioning";
      
      // 如果是双侧栏模式，隐藏右侧边栏并调整主网格布局
      if (isBothSidebars && rightSidebar) {
        rightSidebar.style.transition = 'opacity 0.3s ease-out';
        rightSidebar.style.opacity = '0';
        setTimeout(() => {
          rightSidebar.style.display = 'none';
        }, 300);
        
        // 标记网格模式状态
        if (mainGrid) {
          mainGrid.classList.add('grid-layout-active');
        }
      }
    } else {
      // 切换到列表模式
      postListContainer.className =
        "transition-all duration-500 flex flex-col gap-4 md:gap-4 mb-4 layout-transitioning";
      
      // 如果是双侧栏模式，显示右侧边栏并恢复网格布局
      if (isBothSidebars && rightSidebar) {
        rightSidebar.style.display = '';
        rightSidebar.style.transition = 'opacity 0.3s ease-in';
        rightSidebar.style.opacity = '0';
        setTimeout(() => {
          rightSidebar.style.opacity = '1';
        }, 10);
        
        // 移除网格模式标记
        if (mainGrid) {
          mainGrid.classList.remove('grid-layout-active');
        }
      }
    }

    // 移除过渡类
    setTimeout(() => {
      postListContainer.classList.remove('layout-transitioning');
    }, 500);

    // 布局应用后显示容器
    postListContainer.style.opacity = "1";
  }

  // 页面加载时初始化布局
  document.addEventListener("DOMContentLoaded", function () {
    // 延迟一点确保DOM完全加载
    setTimeout(initLayout, 50);
  });

  // 页面显示时也初始化布局（处理页面切换）
  document.addEventListener("visibilitychange", function () {
    if (!document.hidden) {
      setTimeout(initLayout, 100);
    }
  });

  // 监听布局变化事件
  window.addEventListener("layoutChange", function (event: CustomEvent) {
    const newLayout = event.detail.layout;
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;
    
    // 检查屏幕宽度，如果小于1200px则强制使用列表模式
    const screenWidth = window.innerWidth;
    const isSmallScreen = screenWidth < 1200;

    if (isSmallScreen) {
      updatePostListLayout("list");
    } else {
      updatePostListLayout(newLayout);
    }
  });

  // 监听窗口大小变化
  let resizeTimeout;
  window.addEventListener("resize", function () {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function () {
      initLayout();
    }, 250);
  });

  // 监听页面导航事件（Astro的客户端路由）
  document.addEventListener("astro:page-load", function () {
    setTimeout(initLayout, 50);
  });
  document.addEventListener("astro:after-swap", function () {
    setTimeout(initLayout, 50);
  });

  // 立即执行一次（处理页面刷新）
  setTimeout(initLayout, 0);
</script>
