---
import type { MarkdownHeading } from "astro";
import { i18n } from "@/i18n/translation";
import I18nKey from "@/i18n/i18nKey";
import WidgetLayout from "./WidgetLayout.astro";
import TOCStyles from "@/components/common/TOCStyles.astro";

interface Props {
  headings: MarkdownHeading[];
  class?: string;
  style?: string;
}

const { headings = [], class: className, style } = Astro.props;
---

<WidgetLayout 
  name={i18n(I18nKey.tableOfContents)} 
  id="sidebar-toc"
  class={className}
  style={style}
>
  <div class="toc-scroll-container">
    <div
      class="toc-content"
      id="sidebar-toc-content"
    >
      <!-- TOC内容将由JavaScript动态生成 -->
    </div>
  </div>
</WidgetLayout>

<TOCStyles />

<style lang="stylus">
/* SidebarTOC 特定样式 */
.toc-scroll-container
	max-height: calc(100vh - 20rem)
</style>

<script is:inline>
  if (typeof window.SidebarTOC === "undefined") {
    window.SidebarTOC = {
      manager: null
    };
  }

  async function initSidebarTOC() {
    const tocContent = document.getElementById("sidebar-toc-content");
    if (!tocContent) return;

    try {
      // 动态导入 TOCManager
      const { TOCManager } = await import("/src/utils/tocUtils.ts");

      // 清理旧实例
      if (window.SidebarTOC.manager) {
        window.SidebarTOC.manager.cleanup();
      }

      // 创建新实例
      window.SidebarTOC.manager = new TOCManager({
        contentId: "sidebar-toc-content",
        indicatorId: "sidebar-active-indicator",
        maxLevel: 3,
        scrollOffset: 80,
      });

      // 初始化
      window.SidebarTOC.manager.init();
    } catch (error) {
      console.error("Failed to load TOCManager for SidebarTOC:", error);
    }
  }

  // 初始化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSidebarTOC);
  } else {
    initSidebarTOC();
  }

  // 页面切换时重新初始化
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(initSidebarTOC, 100);
  });
</script>
