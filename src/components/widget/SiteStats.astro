---
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getSortedPosts } from "@/utils/content-utils";
import { getCategoryList, getTagList } from "@/utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
  class?: string;
  style?: string;
  siteStartDate?: string; // 站点开始日期，格式: "2024-01-01"
}

const { class: className, style, siteStartDate = "2024-01-01" } = Astro.props;

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
  if (post.body) {
    // 移除 Markdown 语法和空白字符后计算字数
    const text = post.body
      .replace(/```[\s\S]*?```/g, '') // 移除代码块
      .replace(/`[^`]*`/g, '') // 移除行内代码
      .replace(/!\[.*?\]\(.*?\)/g, '') // 移除图片
      .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // 保留链接文本
      .replace(/[#*_~`>\-+]/g, '') // 移除Markdown符号
      .replace(/\s+/g, ' ') // 合并空白
      .trim();
    
    // 分别计算中文字符和英文单词
    const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
    const englishWords = text.match(/[a-zA-Z]+/g) || [];
    
    totalWords += chineseChars.length + englishWords.length;
  }
}

// 计算运行天数
const startDate = new Date(siteStartDate);
const today = new Date();
const diffTime = Math.abs(today.getTime() - startDate.getTime());
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

// 计算上次更新（最近一篇文章的日期）
let daysSinceLastUpdate = 0;
if (posts.length > 0) {
  // posts已经按日期排序，第一篇是最新的
  const lastPostDate = new Date(posts[0].data.published);
  const timeSinceLastPost = Math.abs(today.getTime() - lastPostDate.getTime());
  daysSinceLastUpdate = Math.floor(timeSinceLastPost / (1000 * 60 * 60 * 24));
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
  return num.toLocaleString();
}

const stats = [
  {
    icon: "material-symbols:article-outline",
    label: i18n(I18nKey.siteStatsPostCount),
    value: posts.length,
  },
  {
    icon: "material-symbols:folder-outline",
    label: i18n(I18nKey.siteStatsCategoryCount),
    value: categories.length,
  },
  {
    icon: "material-symbols:label-outline",
    label: i18n(I18nKey.siteStatsTagCount),
    value: tags.length,
  },
  {
    icon: "material-symbols:text-ad-outline-rounded",
    label: i18n(I18nKey.siteStatsTotalWords),
    value: totalWords,
    formatted: true
  },
  {
    icon: "material-symbols:calendar-clock-outline",
    label: i18n(I18nKey.siteStatsRunningDays),
    value: diffDays,
    suffix: i18n(I18nKey.siteStatsDays).replace("{days}", "")
  },
  {
    icon: "material-symbols:ecg-heart-outline",
    label: i18n(I18nKey.siteStatsLastUpdate),
    value: daysSinceLastUpdate,
    suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", "")
  }
];
---

<WidgetLayout name={i18n(I18nKey.siteStats)} id="site-stats" class={className} style={style}>
  <div class="flex flex-col gap-2">
    {stats.map((stat) => (
      <div class="flex items-center justify-between group hover:bg-[var(--btn-plain-bg-hover)] rounded-lg px-3 py-1.5 transition-colors">
        <div class="flex items-center gap-2.5">
          <div class="text-[var(--primary)] text-xl transition-transform group-hover:scale-110">
            <Icon name={stat.icon} />
          </div>
          <span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm">
            {stat.label}
          </span>
        </div>
        <div class="flex items-center">
          <span class="text-base font-bold text-neutral-900 dark:text-neutral-100">
            {stat.formatted ? formatNumber(stat.value) : stat.value}
          </span>
          {stat.suffix && (
            <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
              {stat.suffix}
            </span>
          )}
        </div>
      </div>
    ))}
  </div>
</WidgetLayout>

<style>
  /* 添加一些额外的样式 */
  .flex:hover {
    transform: translateX(2px);
  }
</style>
