---
import * as path from "node:path";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
	fallback?: string; // 图片加载失败时的备用图片
	seed?: string; // 用于生成随机图API的种子（文章slug）
	preview?: boolean; // 是否是预览模式（文章列表页），true为预览模式（小尺寸），false为详情页（大尺寸）
}

import { Image } from "astro:assets";
import { url } from "@/utils/url-utils";
import { coverImageConfig } from "@/config/coverImageConfig";
import { generateApiUrls } from "@/utils/image-utils";

const { id, src, alt, position = "center", basePath = "/", fallback, seed, preview = false } = Astro.props;
const className = Astro.props.class;

// 检查是否是API图片（以http或https开头）
const isApiImage = src.startsWith("http://") || src.startsWith("https://");
// 如果是随机图API（包含query参数v=），需要尝试所有API
// 我们通过检查URL是否包含hash参数来判断是否是随机图API
const isRandomApiImage = isApiImage && src.includes("?v=");
// 如果是随机图API，生成所有API URL列表用于客户端重试
// 使用传入的seed（文章slug）来生成所有API URL，确保每个文章使用相同的seed但不同的API
let allApiUrls: string[] = [];
if (isRandomApiImage && coverImageConfig.enable && coverImageConfig.apis && coverImageConfig.apis.length > 0) {
	// 为每个API生成URL（使用相同的seed确保同一文章的所有API URL都基于相同的hash）
	// 即使只有一个API也生成列表，以便统一处理重试逻辑
	allApiUrls = generateApiUrls(seed);
}

const isLocal = !(
	src.startsWith("/") ||
	src.startsWith("http") ||
	src.startsWith("https") ||
	src.startsWith("data:")
);
const isPublic = src.startsWith("/");

// 确定fallback图片路径：
// 对于随机图API：如果enable为false，不使用fallback；如果enable为true，可以使用fallback
// 对于其他图片：使用传入的fallback
let fallbackSrc = "";
if (isRandomApiImage) {
  // 随机图API：只有当enable为true时才使用fallback
  if (coverImageConfig.enable) {
    fallbackSrc = fallback || coverImageConfig.fallback || "";
  }
} else {
  // 普通图片：使用传入的fallback
  fallbackSrc = fallback || "";
}


// 处理fallback URL：如果是本地路径（以/开头），使用url()函数处理；如果是http/https，直接使用
const getFallbackUrl = (src: string): string => {
	if (!src) return "";
	if (src.startsWith("http://") || src.startsWith("https://")) {
		return src;
	}
	if (src.startsWith("/")) {
		return url(src);
	}
	return url(`/${src}`);
};

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>("../../**", {
		import: "default",
	});
	let normalizedPath = path
		.normalize(path.join("../../", basePath, src))
		.replace(/\\/g, "/");
	const file = files[normalizedPath];
	if (!file) {
		console.error(
			`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
		);
	}
	img = await file();
}

// 仅在文章封面/预览/随机图场景下强制铺满容器，其他场景（如头像等内联图片）不强制尺寸
const isCoverContext = Boolean(preview || seed || isRandomApiImage);
const imageClass = isCoverContext ? "w-full h-full object-cover" : "object-cover";
// 支持所有 CSS object-position 值
// 添加图片渲染优化，确保大图片在缩小显示时平滑清晰
// 使用 -webkit-optimize-contrast 确保缩放时平滑，避免像素点
const imageStyle = `object-position: ${position || 'center'}; image-rendering: -webkit-optimize-contrast;`;

// 水印配置
const watermark = coverImageConfig.watermark;
const showWatermark = isRandomApiImage && watermark?.enable;

// 生成水印位置样式和类名
const getWatermarkStyles = (pos?: string): { classes: string; styles: string } => {
	const position = pos || "bottom-right";
	let classes = "";
	let styles = "";
	
	switch (position) {
		case "top-left":
			// 移动端和桌面端都显示在左上
			classes = "top-2 left-2";
			break;
		case "top-right":
			// 移动端和桌面端都显示在右上
			classes = "top-2 right-2";
			break;
		case "bottom-left":
			// 移动端显示在左上（避免被裁剪），桌面端显示在左下
			classes = "top-2 left-2 md:top-auto md:bottom-2 md:left-2";
			break;
		case "bottom-right":
			// 移动端显示在右上（避免被裁剪），桌面端显示在右下
			classes = "top-2 right-2 md:top-auto md:bottom-2 md:right-2";
			break;
		case "center":
			// 移动端和桌面端都居中
			classes = "top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2";
			break;
		default:
			// 默认：移动端右上，桌面端右下
			classes = "top-2 right-2 md:top-auto md:bottom-2 md:right-2";
	}
	
	styles = `padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: ${watermark?.fontSize || "0.75rem"}; color: ${watermark?.color || "#ffffff"}; background-color: ${watermark?.backgroundColor || "rgba(0, 0, 0, 0.4)"}; opacity: ${watermark?.opacity || 0.6}; pointer-events: none; z-index: 10; white-space: nowrap; user-select: none;`;
	
	return { classes, styles };
};

const watermarkStyles = showWatermark ? getWatermarkStyles(watermark?.position) : { classes: "", styles: "" };
---
<div id={id} class:list={[
  className,
  'overflow-hidden relative',
  // 仅封面/预览场景设置占位最小高度，避免影响头像等内联图片
  preview ? 'min-h-[150px] md:min-h-0' : (isCoverContext ? 'min-h-[300px]' : '')
]}> 
    <!-- 加载指示器：只对远程API图片（非本地且不是public路径）显示 -->
    {!isLocal && (seed || preview) && (
      <div 
        class="image-loading-indicator absolute inset-0 flex items-center justify-center z-20 transition-opacity duration-300"
        style={`background-color: ${coverImageConfig.loading?.backgroundColor || '#fefefe'};`}
      >
        <img 
          src={url(coverImageConfig.loading?.image || "/assets/images/loading.gif")} 
          alt="Loading..." 
          class="w-24 h-24 md:w-32 md:h-32 opacity-80" 
        />
      </div>
    )}
    {isLocal && img && (
      preview ? (
        // 预览模式（文章列表）：使用较小的尺寸
        <Image 
          src={img} 
          alt={alt || ""} 
          class={imageClass} 
          style={imageStyle}
          width={400}
          height={300}
          loading="lazy"
          format="webp"
          quality={80}
          widths={[200, 400, 600]}
          sizes="(max-width: 768px) 100vw, 28vw"
        />
      ) : (
        // 详情页模式：使用较大的尺寸以展示完整图片
        <Image 
          src={img} 
          alt={alt || ""} 
          class={imageClass} 
          style={imageStyle}
          width={1200}
          height={800}
          loading="lazy"
          format="webp"
          quality={90}
          widths={[800, 1200, 1600, 2000]}
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
        />
      )
    )}
    {!isLocal && (
      <img 
        src={isPublic ? url(src) : src} 
        alt={alt || ""} 
        class:list={[
          imageClass,
          // 仅封面/预览才应用强制最小高度的样式类
          isCoverContext ? (preview ? 'api-preview-image' : 'api-full-image') : ''
        ]}
        style={imageStyle}
        loading="lazy"
        decoding="async"
        data-preview={preview ? "true" : "false"}
        data-seed={seed || ""}
        data-api-urls={allApiUrls.length > 0 ? JSON.stringify(allApiUrls) : ""}
        data-fallback={fallbackSrc ? getFallbackUrl(fallbackSrc) : ""}
        data-api-index={allApiUrls.length > 0 ? "0" : ""}
        data-enable={isRandomApiImage ? (coverImageConfig.enable ? "true" : "false") : ""}
        data-need-check-fallback="true"
        onloadstart={`(function(img){
          // 图片开始加载时，确保加载指示器显示（特别是移动端lazy loading）
          const container = img.parentElement;
          if (container) {
            const loadingIndicator = container.querySelector('.image-loading-indicator');
            if (loadingIndicator) {
              loadingIndicator.classList.remove('hidden');
              loadingIndicator.style.removeProperty('opacity');
              loadingIndicator.style.removeProperty('display');
            }
          }
        })(this);`}
        onload={`(function(img){
          // 图片加载成功后，使用固定延迟确保图片已经渲染完成
          // 等待足够长的时间，确保图片完全显示在屏幕上
          if (img.naturalWidth > 0 && img.naturalHeight > 0) {
            // 固定延迟800ms，确保图片有足够时间渲染到屏幕上
            setTimeout(function() {
              const container = img.parentElement;
              if (container) {
                const loadingIndicator = container.querySelector('.image-loading-indicator');
                if (loadingIndicator) {
                  // 使用淡出动画
                  loadingIndicator.style.setProperty('opacity', '0', 'important');
                  loadingIndicator.style.setProperty('transition', 'opacity 0.3s ease-out', 'important');
                  setTimeout(function() {
                    loadingIndicator.style.setProperty('display', 'none', 'important');
                    loadingIndicator.classList.add('hidden');
                  }, 300);
                }
                // 显示水印
                const watermarkEl = container.querySelector('[data-watermark]');
                if (watermarkEl && watermarkEl.getAttribute('data-watermark-visible') !== 'true') {
                  watermarkEl.setAttribute('data-watermark-visible', 'true');
                  watermarkEl.classList.remove('opacity-0');
                  watermarkEl.classList.add('opacity-100');
                  // 使用配置的水印透明度
                  const originalOpacity = watermarkEl.getAttribute('data-original-opacity') || '0.6';
                  watermarkEl.style.opacity = originalOpacity;
                }
              }
            }, 800); // 800ms固定延迟
          }
        })(this);`}
        onerror={`(function(img){
          try {
            const apiUrls = img.dataset.apiUrls ? JSON.parse(img.dataset.apiUrls) : [];
            // 重新读取以确保获取最新值
            let currentIndex = parseInt(img.dataset.apiIndex || '0');
            const isEnabled = img.dataset.enable !== 'false';
            const fallbackUrl = img.dataset.fallback;
            
            // 如果还有更多API可以尝试（注意：currentIndex 是从0开始的，所以最后一个索引是 length-1）
            if (apiUrls.length > 0 && currentIndex < apiUrls.length - 1) {
              currentIndex = currentIndex + 1;
              // 先更新 index
              img.dataset.apiIndex = currentIndex.toString();
              // 不要清除 onerror，让它可以继续处理下一个 API 的失败
              // 直接设置新的 src，如果失败会再次触发这个 onerror
              img.src = apiUrls[currentIndex];
            } 
            // 所有API都失败了（currentIndex >= apiUrls.length - 1），且enable为true且有fallback，使用备用图片
            else if (isEnabled && fallbackUrl && fallbackUrl.length > 0) {
              // 记录API失败状态到localStorage（如果有seed）
              const seed = img.dataset.seed;
              if (seed) {
                try {
                  localStorage.setItem('api_image_failed_' + seed, 'true');
                } catch (e) {
                  // localStorage可能不可用，忽略错误
                }
              }
              // 更新水印文字为"Image API Error"（如果存在）
              const container = img.parentElement;
              if (container) {
                const watermarkEl = container.querySelector('[data-watermark]');
                if (watermarkEl) {
                  watermarkEl.textContent = 'Image API Error';
                  watermarkEl.setAttribute('data-error', 'true');
                }
              }
              // 清除 onerror 以防止无限循环
              img.onerror = null;
              // 设置fallback图片，并在加载成功后显示水印
              img.src = fallbackUrl;
              // 添加load事件监听器，确保fallback图片加载成功后显示水印并隐藏加载指示器
              img.addEventListener('load', function() {
                if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                  const container = img.parentElement;
                  if (container) {
                    // 隐藏加载指示器
                    const loadingIndicator = container.querySelector('.image-loading-indicator');
                    if (loadingIndicator) {
                      loadingIndicator.style.opacity = '0';
                      setTimeout(function() {
                        loadingIndicator.style.display = 'none';
                      }, 300);
                    }
                    // 显示水印
                    const watermarkEl = container.querySelector('[data-watermark]');
                    if (watermarkEl && watermarkEl.getAttribute('data-watermark-visible') !== 'true') {
                      watermarkEl.setAttribute('data-watermark-visible', 'true');
                      watermarkEl.classList.remove('opacity-0');
                      watermarkEl.classList.add('opacity-100');
                      const originalOpacity = watermarkEl.getAttribute('data-original-opacity') || '0.6';
                      watermarkEl.style.opacity = originalOpacity;
                      watermarkEl.style.setProperty('opacity', originalOpacity, 'important');
                    }
                  }
                }
              }, { once: true });
            } 
            // 其他情况：隐藏图片和加载指示器
            else {
              img.onerror = null;
              img.style.display = 'none';
              // 隐藏加载指示器
              const container = img.parentElement;
              if (container) {
                const loadingIndicator = container.querySelector('.image-loading-indicator');
                if (loadingIndicator) {
                  loadingIndicator.style.opacity = '0';
                  setTimeout(function() {
                    loadingIndicator.style.display = 'none';
                  }, 300);
                }
              }
            }
          } catch(e) {
            // 解析错误时，如果有fallback且enable为true，尝试使用fallback
            const isEnabled = img.dataset.enable !== 'false';
            const fallbackUrl = img.dataset.fallback;
            const seed = img.dataset.seed;
            if (isEnabled && fallbackUrl && fallbackUrl.length > 0) {
              // 记录API失败状态到localStorage（如果有seed）
              if (seed) {
                try {
                  localStorage.setItem('api_image_failed_' + seed, 'true');
                } catch (e) {
                  // localStorage可能不可用，忽略错误
                }
              }
              // 更新水印文字为"Image API Error"（如果存在）
              const container = img.parentElement;
              if (container) {
                const watermarkEl = container.querySelector('[data-watermark]');
                if (watermarkEl) {
                  watermarkEl.textContent = 'Image API Error';
                  watermarkEl.setAttribute('data-error', 'true');
                }
              }
              img.onerror = null;
              img.src = fallbackUrl;
            } else {
              img.onerror = null;
              img.style.display = 'none';
              // 隐藏加载指示器
              const container = img.parentElement;
              if (container) {
                const loadingIndicator = container.querySelector('.image-loading-indicator');
                if (loadingIndicator) {
                  loadingIndicator.style.opacity = '0';
                  setTimeout(function() {
                    loadingIndicator.style.display = 'none';
                  }, 300);
                }
              }
            }
          }
        })(this);`}
      />
    )}
    {showWatermark && (
      <div 
        data-watermark="true"
        data-watermark-visible="false"
        data-original-opacity={watermark?.opacity || "0.6"}
        class:list={["absolute", watermarkStyles.classes, "pointer-events-none", "z-10"]}
        style={`${watermarkStyles.styles} opacity: 0 !important;`}
      >
        {watermark?.text || "Random Cover"}
      </div>
    )}
</div>

<style>
  /* 图片容器样式 */
  /* 注意：背景色通过内联样式动态设置，确保与配置的加载图背景色一致 */
  /* 加载指示器默认就是显示的，直到图片加载完成后才隐藏 */
  .image-loading-indicator {
    opacity: 1 !important;
    display: flex !important;
    visibility: visible !important;
    /* 确保在移动端也能正确显示 */
    z-index: 20;
  }
  
  /* 图片加载完成后，隐藏加载指示器（由JavaScript控制） */
  /* 注意：不使用CSS兄弟选择器，因为加载指示器不是图片的兄弟元素 */
  .image-loading-indicator.hidden {
    opacity: 0 !important;
    display: none !important;
    visibility: hidden !important;
  }
  
  /* 预览模式下优化API图片显示，限制最大尺寸避免像素点 */
  img.api-preview-image,
  img[data-preview="true"] {
    /* 确保图片在移动端能撑开容器，特别是lazy loading时 */
    min-height: 150px;
    /* 桌面端取消最小高度限制 */
    @media (min-width: 768px) {
      min-height: 0;
    }
    /* 图片渲染优化 - 确保大图缩小显示时平滑清晰 */
    image-rendering: -webkit-optimize-contrast !important;
    image-rendering: auto !important;
    /* 启用硬件加速优化缩放性能 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    will-change: transform;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    /* 优化图片缩放算法 */
    -ms-interpolation-mode: bicubic;
    /* 确保图片在容器内正确填充 */
    object-fit: cover !important;
    /* 防止图片溢出容器 */
    max-width: 100%;
    max-height: 100%;
    /* 限制预览模式下图片的实际渲染尺寸，强制浏览器进行高质量缩放 */
    width: 100%;
    height: 100%;
  }
  
  /* 详情页模式下的API图片优化 */
  img.api-full-image {
    /* 确保图片在移动端和桌面端都能撑开容器，特别是lazy loading时 */
    min-height: 300px;
    image-rendering: -webkit-optimize-contrast !important;
    image-rendering: auto !important;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    object-fit: cover !important;
    /* 确保图片在容器内正确填充 */
    width: 100%;
    height: 100%;
  }
</style>

<script is:inline>
  // 优化预览模式下API图片的显示
  // 在图片加载完成后，强制浏览器使用优化后的缩放算法
  (function() {
    // 检测是否是页面刷新（F5）或首次加载
    // 返回 true 表示应该清除缓存，false 表示应该使用缓存
    function isPageRefresh() {
      try {
        // 方法1：使用 PerformanceNavigationTiming API（推荐，现代浏览器）
        if (window.performance && window.performance.getEntriesByType) {
          const navEntries = window.performance.getEntriesByType('navigation');
          if (navEntries.length > 0) {
            const navEntry = navEntries[0];
            const navType = navEntry.type;
            // 'reload' 表示刷新（F5），'navigate' 表示首次加载或通过地址栏导航
            // 'back_forward' 表示前进/后退
            if (navType === 'reload' || navType === 'navigate') {
              return true;
            }
            // 'back_forward' 表示前进/后退，不应该清除缓存
            if (navType === 'back_forward') {
              return false;
            }
          }
        }
        // 方法2：降级方案 - 使用 PerformanceNavigation API（已废弃但兼容性好）
        if (window.performance && window.performance.navigation) {
          const navType = window.performance.navigation.type;
          // 0 = TYPE_NAVIGATE（首次加载）, 1 = TYPE_RELOAD（刷新）, 2 = TYPE_BACK_FORWARD（前进/后退）
          if (navType === 1 || navType === 0) {
            return true;
          }
          // TYPE_BACK_FORWARD (2) 不应该清除缓存
          if (navType === 2) {
            return false;
          }
        }
        // 方法3：使用 sessionStorage + 页面加载时间戳
        // 结合使用多个标记来判断
        const refreshCheckKey = 'api_image_last_init_time';
        const navigationCheckKey = 'api_image_navigation_type';
        const now = Date.now();
        const lastInitTime = sessionStorage.getItem(refreshCheckKey);
        const lastNavType = sessionStorage.getItem(navigationCheckKey);
        
        // 如果没有上次初始化时间，或时间间隔超过10秒，认为是刷新
        // 或者是通过链接导航（而不是返回）
        if (!lastInitTime || (now - parseInt(lastInitTime)) > 10000) {
          sessionStorage.setItem(refreshCheckKey, now.toString());
          sessionStorage.setItem(navigationCheckKey, 'refresh');
          return true;
        }
        
        // 如果上次导航类型是 'back_forward'，且时间间隔短，认为是返回，不清除缓存
        if (lastNavType === 'back_forward' && (now - parseInt(lastInitTime)) < 5000) {
          return false;
        }
        
        // 默认认为是刷新（清除缓存），这样更安全
        sessionStorage.setItem(refreshCheckKey, now.toString());
        sessionStorage.setItem(navigationCheckKey, 'refresh');
        return true;
      } catch (e) {
        // 如果所有检测方法都失败，保守策略：认为是刷新（清除缓存）
        // 这样可以确保F5刷新和首次加载时都能清除缓存
        console.warn('Unable to detect page refresh type, clearing cache as fallback', e);
        return true;
      }
    }
    
    // 清除所有API失败记录
    function clearApiFailureCache() {
      try {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('api_image_failed_')) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(function(key) {
          localStorage.removeItem(key);
        });
        if (keysToRemove.length > 0) {
          console.log('Cleared ' + keysToRemove.length + ' API failure records on page refresh');
        }
      } catch (e) {
        console.warn('Failed to clear API failure cache', e);
      }
    }
    
    // 检查并处理已失败的API图片（列表页和详情页都处理，直接使用fallback）
    function checkAndUseFallbackForFailedApis() {
      // 处理所有API图片（包括预览模式和详情页模式）
      const allApiImages = document.querySelectorAll('img[data-seed][data-fallback][data-enable="true"]');
      
      allApiImages.forEach(function(img) {
        const seed = img.dataset.seed;
        const fallbackUrl = img.dataset.fallback;
        
        if (seed && fallbackUrl) {
          try {
            const failureKey = 'api_image_failed_' + seed;
            if (localStorage.getItem(failureKey) === 'true') {
              // 如果已经标记为失败，直接使用fallback，不再尝试API
              // 检查当前src是否已经是fallback，避免重复设置
              if (img.src !== fallbackUrl && !img.src.includes(fallbackUrl.split('?')[0])) {
                img.src = fallbackUrl;
              }
              // 更新水印为错误状态，并在图片加载成功后显示
              const container = img.parentElement;
              if (container) {
                const watermarkEl = container.querySelector('[data-watermark]');
                if (watermarkEl) {
                  watermarkEl.textContent = 'Image API Error';
                  watermarkEl.setAttribute('data-error', 'true');
                  // 隐藏加载指示器
                  const loadingIndicator = container.querySelector('.image-loading-indicator');
                  // 如果图片已经加载完成，立即显示水印
                  if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
                    if (loadingIndicator) {
                      loadingIndicator.style.opacity = '0';
                      setTimeout(function() {
                        loadingIndicator.style.display = 'none';
                      }, 300);
                    }
                    watermarkEl.setAttribute('data-watermark-visible', 'true');
                    watermarkEl.classList.remove('opacity-0');
                    watermarkEl.classList.add('opacity-100');
                    const originalOpacity = watermarkEl.getAttribute('data-original-opacity') || '0.6';
                    watermarkEl.style.opacity = originalOpacity;
                    watermarkEl.style.setProperty('opacity', originalOpacity, 'important');
                  } else {
                    // 等待图片加载成功后显示水印并隐藏加载指示器
                    img.addEventListener('load', function() {
                      if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                        if (loadingIndicator) {
                          loadingIndicator.style.opacity = '0';
                          setTimeout(function() {
                            loadingIndicator.style.display = 'none';
                          }, 300);
                        }
                        watermarkEl.setAttribute('data-watermark-visible', 'true');
                        watermarkEl.classList.remove('opacity-0');
                        watermarkEl.classList.add('opacity-100');
                        const originalOpacity = watermarkEl.getAttribute('data-original-opacity') || '0.6';
                        watermarkEl.style.opacity = originalOpacity;
                        watermarkEl.style.setProperty('opacity', originalOpacity, 'important');
                      }
                    }, { once: true });
                  }
                }
              }
            }
          } catch (e) {
            // localStorage可能不可用，忽略错误
          }
        }
      });
    }
    
    // 显示加载指示器（只对文章封面图）
    function showLoadingIndicator(img) {
      // 只处理有data-seed或data-preview属性的图片（文章封面图）
      if (!img.dataset.seed && img.dataset.preview !== 'true') {
        return;
      }
      const container = img.closest('[id]') || img.parentElement;
      if (container) {
        const loadingIndicator = container.querySelector('.image-loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.classList.remove('hidden');
          loadingIndicator.style.removeProperty('opacity');
          loadingIndicator.style.removeProperty('display');
        }
      }
    }
    
    // 隐藏加载指示器（带淡出动画，只对文章封面图）
    function hideLoadingIndicator(img) {
      // 只处理有data-seed或data-preview属性的图片（文章封面图）
      if (!img.dataset.seed && img.dataset.preview !== 'true') {
        return;
      }
      const container = img.closest('[id]') || img.parentElement;
      if (container) {
        const loadingIndicator = container.querySelector('.image-loading-indicator');
        if (loadingIndicator) {
          // 使用固定延迟策略，确保图片有足够时间渲染
          setTimeout(function() {
            loadingIndicator.style.setProperty('opacity', '0', 'important');
            loadingIndicator.style.setProperty('transition', 'opacity 0.3s ease-out', 'important');
            setTimeout(function() {
              loadingIndicator.style.setProperty('display', 'none', 'important');
              loadingIndicator.classList.add('hidden');
            }, 300);
          }, 800); // 800ms固定延迟，确保图片完全显示
        }
      }
    }
    
    // 显示水印（在图片加载成功后）
    function showWatermark(img) {
      if (!img.complete || img.naturalWidth === 0 || img.naturalHeight === 0) {
        return;
      }
      hideLoadingIndicator(img);
      const container = img.closest('[id]') || img.parentElement;
      if (container) {
        const watermarkEl = container.querySelector('[data-watermark]');
        if (watermarkEl && watermarkEl.getAttribute('data-watermark-visible') !== 'true') {
          watermarkEl.setAttribute('data-watermark-visible', 'true');
          watermarkEl.classList.remove('opacity-0');
          watermarkEl.classList.add('opacity-100');
          const originalOpacity = watermarkEl.getAttribute('data-original-opacity') || '0.6';
          watermarkEl.style.opacity = originalOpacity;
          watermarkEl.style.setProperty('opacity', originalOpacity, 'important');
        }
      }
    }
    
    // 处理预览图片（已经通过onload事件处理，这里主要是初始化显示加载指示器）
    function optimizePreviewImages() {
      const previewImages = document.querySelectorAll('img[data-preview="true"]');
      previewImages.forEach(function(img) {
        if (!img.complete || img.naturalWidth === 0 || img.naturalHeight === 0) {
          showLoadingIndicator(img);
          img.addEventListener('loadstart', function() {
            showLoadingIndicator(img);
          }, { once: true });
        }
      });
    }
    
    // 监听动态添加的图片（用于SPA或动态加载的场景）
    function setupObserver() {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === Node.ELEMENT_NODE) {
              const element = node;
              // 处理新添加的API图片（包括预览和详情页）
              const apiImages = [];
              if (element.tagName === 'IMG' && element.dataset.seed && element.dataset.fallback) {
                apiImages.push(element);
              }
              const childApiImages = element.querySelectorAll ? element.querySelectorAll('img[data-seed][data-fallback]') : [];
              childApiImages.forEach(function(img) {
                if (!apiImages.includes(img)) {
                  apiImages.push(img);
                }
              });
              
              apiImages.forEach(function(img) {
                showLoadingIndicator(img);
                if (img.getAttribute('data-need-check-fallback') === 'true') {
                  checkAndUseFallbackForFailedApis();
                  img.removeAttribute('data-need-check-fallback');
                }
                if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
                  hideLoadingIndicator(img);
                  showWatermark(img);
                } else {
                  img.addEventListener('loadstart', function() {
                    showLoadingIndicator(img);
                  }, { once: true });
                  img.addEventListener('load', function() {
                    if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                      hideLoadingIndicator(img);
                      showWatermark(img);
                    }
                  }, { once: true });
                  img.addEventListener('error', function() {
                    setTimeout(function() {
                      hideLoadingIndicator(img);
                    }, 500);
                  }, { once: true });
                }
              });
            }
          });
        });
      });
      
      // 开始观察文档变化
      if (document.body) {
        observer.observe(document.body, { childList: true, subtree: true });
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          observer.observe(document.body, { childList: true, subtree: true });
        });
      }
    }
    
    // 页面加载完成后执行优化
    function initializeImages() {
      // 检测是否是页面刷新，如果是则清除失败记录
      if (isPageRefresh()) {
        clearApiFailureCache();
        // 刷新后不执行fallback检查，让图片重新尝试API
      } else {
        // 如果不是刷新（例如从其他页面返回），检查并使用已失败的fallback
        checkAndUseFallbackForFailedApis();
      }
      optimizePreviewImages();
      
      // 处理所有API图片（包括预览和详情页）的加载指示器
      const allApiImages = document.querySelectorAll('img[data-seed][data-fallback]');
      allApiImages.forEach(function(img) {
        showLoadingIndicator(img);
        img.addEventListener('loadstart', function() {
          showLoadingIndicator(img);
        }, { once: true });
        
        if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
          hideLoadingIndicator(img);
          showWatermark(img);
        } else {
          img.addEventListener('load', function() {
            if (img.naturalWidth > 0 && img.naturalHeight > 0) {
              hideLoadingIndicator(img);
              showWatermark(img);
            }
          }, { once: true });
          img.addEventListener('error', function() {
            setTimeout(function() {
              hideLoadingIndicator(img);
            }, 500);
          }, { once: true });
        }
      });
      
      setupObserver();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeImages);
    } else {
      initializeImages();
    }
    
    // 监听页面可见性变化（从其他页面返回时重新检查）
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // 页面变为可见时，如果不是刷新，重新检查并使用fallback（避免重新加载API）
        if (!isPageRefresh()) {
          setTimeout(checkAndUseFallbackForFailedApis, 100);
        }
      }
    });
    
    // 监听popstate事件（浏览器前进/后退）
    window.addEventListener('popstate', function() {
      // 标记这是前进/后退操作
      try {
        sessionStorage.setItem('api_image_navigation_type', 'back_forward');
        sessionStorage.setItem('api_image_last_init_time', Date.now().toString());
      } catch (e) {
        // 忽略错误
      }
      // 延迟一点执行，确保DOM已更新
      // 前进/后退时，检查并使用fallback（不是刷新，不清除缓存）
      setTimeout(function() {
        checkAndUseFallbackForFailedApis();
      }, 50);
    });
  })();
</script>
