---
import BangumiSection from "@/components/pages/bangumi/BangumiSection.astro";
import TabNav from "@/components/pages/bangumi/TabNav.astro";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import type {
  UserSubjectCollection,
  UserSubjectCollectionResponse,
} from "@/types/bangumi";

//å‚è€ƒï¼šéœè‘‰ https://kasuha.com/posts/fuwari-enhance-ep2/

// æ£€æŸ¥é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.pages.anime) {
  return Astro.redirect("/404/");
}

//////////////// Bangumi é…ç½® ////////////////////////
const bangumiConfig = {
  username: siteConfig.bangumi?.userId, // åœ¨è¿™é‡Œé…ç½®ä½ çš„Bangumiç”¨æˆ·å
  apiUrl: "https://api.bgm.tv",
  categories: {
    book: false,
    anime: true,
    music: false,
    game: true,
    real: false,
  },
  // æ•°æ®è·å–è®¾ç½®
  pagination: {
    limit: 50, // æ¯é¡µè·å–æ•°é‡
    delay: 50, // è¯·æ±‚é—´éš”æ¯«ç§’æ•°ï¼Œé¿å…é¢‘ç‡é™åˆ¶
    maxTotal: 1000, // æœ€å¤§è·å–æ€»æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯ï¼ˆ0=æ— é™åˆ¶ï¼‰
  },
};
////////////////////////////////////////////////////

// åˆ†ç±»æ˜ å°„
const categoryMap = {
  book: { id: "book", name: i18n(I18nKey.bangumiCategoryBook), subjectType: 1 },
  anime: { id: "anime", name: i18n(I18nKey.bangumiCategoryAnime), subjectType: 2 },
  music: { id: "music", name: i18n(I18nKey.bangumiCategoryMusic), subjectType: 3 },
  game: { id: "game", name: i18n(I18nKey.bangumiCategoryGame), subjectType: 4 },
  real: { id: "real", name: i18n(I18nKey.bangumiCategoryReal), subjectType: 6 },
};

// è·å–Bangumiæ•°æ®çš„å‡½æ•° - æ”¯æŒåˆ†é¡µè·å–æ‰€æœ‰æ•°æ®
async function fetchBangumiData(username: string, subjectType: number) {
  try {
    const { limit, delay, maxTotal } = bangumiConfig.pagination;
    let offset = 0;
    let allData: UserSubjectCollection[] = [];
    let hasMore = true;

    console.log(
      `[Bangumi] å¼€å§‹è·å–ç”¨æˆ· ${username} çš„ subjectType ${subjectType} æ•°æ®...`,
    );

    while (hasMore) {
      // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§è·å–é™åˆ¶
      if (maxTotal > 0 && allData.length >= maxTotal) {
        console.log(`[Bangumi] å·²è¾¾åˆ°æœ€å¤§è·å–é™åˆ¶ ${maxTotal}ï¼Œåœæ­¢è·å–`);
        break;
      }

      const url = `${bangumiConfig.apiUrl}/v0/users/${username}/collections?subject_type=${subjectType}&limit=${limit}&offset=${offset}`;

      console.log(`[Bangumi] æ­£åœ¨è·å–æ•°æ®: ${url} (å·²è·å–: ${allData.length})`);

      const response = await fetch(url, {
        headers: {
          "User-Agent": "YuuOuRou Blog",
          Accept: "application/json",
        },
      });

      if (!response.ok) {
        console.warn(
          `[Bangumi] æ— æ³•è·å–æ•°æ® (çŠ¶æ€ç : ${response.status}):`,
          url,
        );
        break;
      }

      const data = (await response.json()) as UserSubjectCollectionResponse;
      const currentBatch = data.data || [];

      if (currentBatch.length > 0) {
        allData = allData.concat(currentBatch);
        offset += limit;

        // å¦‚æœæœ¬æ¬¡è·å–çš„æ•°æ®å°‘äºlimitï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ
        if (currentBatch.length < limit) {
          hasMore = false;
        }
      } else {
        hasMore = false;
      }

      // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
      if (hasMore) {
        await new Promise((resolve) => setTimeout(resolve, delay));
      }
    }

    console.log(`[Bangumi] æ€»å…±è·å–åˆ° ${allData.length} æ¡æ•°æ®`);
    return allData;
  } catch (error) {
    console.error("[Bangumi] è·å–æ•°æ®æ—¶å‡ºé”™:", error);
    return [];
  }
}

// è·å–æ‰€æœ‰å¯ç”¨åˆ†ç±»çš„æ•°æ®
const bangumiData: Record<string, UserSubjectCollection[]> = {};
const tabs: Array<{ id: string; name: string; count: number }> = [];

console.log("[Bangumi] ğŸŒ ä» API è·å–æ•°æ®");

for (const [categoryKey, enabled] of Object.entries(bangumiConfig.categories)) {
  if (enabled && categoryMap[categoryKey as keyof typeof categoryMap]) {
    const categoryInfo = categoryMap[categoryKey as keyof typeof categoryMap];
    try {
      const data = await fetchBangumiData(
        bangumiConfig.username,
        categoryInfo.subjectType,
      );
      bangumiData[categoryKey] = data;
      tabs.push({
        id: categoryKey,
        name: categoryInfo.name,
        count: data.length,
      });
    } catch (error) {
      console.error(`[Bangumi] è·å– ${categoryInfo.name} æ•°æ®å¤±è´¥:`, error);
      bangumiData[categoryKey] = [];
      tabs.push({
        id: categoryKey,
        name: categoryInfo.name,
        count: 0,
      });
    }
  }
}

const activeTab = tabs[0]?.id || "anime";

// è·å–æ„å»ºæ—¶é—´
const buildTime = new Date().toLocaleString();
---

<MainGridLayout title={i18n(I18nKey.bangumi)} description={i18n(I18nKey.animeSubtitle)}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="relative w-full mb-8">
            <div class="mb-6">
                <h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2">
                    {i18n(I18nKey.bangumiTitle)}
                </h1>
                <p class="text-black/75 dark:text-white/75">
                    {i18n(I18nKey.animeSubtitle)}
                </p>
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                    {i18n(I18nKey.bangumiLastUpdated)} {buildTime}
                </p>
            </div>

      <!-- Tab å¯¼èˆªå’Œå†…å®¹ -->
      {tabs.length > 0 ? (
        <>
          <TabNav tabs={tabs} activeTab={activeTab} />

          <!-- å†…å®¹åŒºåŸŸ -->
          {tabs.map((tab) => (
                      <BangumiSection
            sectionId={tab.id}
            items={bangumiData[tab.id] || []}
            isActive={tab.id === activeTab}
            itemsPerPage={6}
          />
          ))}
        </>
      ) : (
        <div class="text-center py-12">
          <h2 class="text-xl font-medium text-gray-600 dark:text-gray-400 mb-2">
            {i18n(I18nKey.bangumiEmpty)}
          </h2>
          <p class="text-gray-500 dark:text-gray-400 mb-4">
            {i18n(I18nKey.bangumiEmptyReason)}
          </p>
          <div class="text-sm text-gray-400 dark:text-gray-500 space-y-1">
            <div>{i18n(I18nKey.bangumiUsername)}: {bangumiConfig.username}</div>
            <div>{i18n(I18nKey.bangumiApi)}: {bangumiConfig.apiUrl}</div>
            <div class="mt-3 text-xs">
              {i18n(I18nKey.bangumiConfigTip)}
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</MainGridLayout>

<style>
  /* è‡ªå®šä¹‰æ ·å¼ */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>